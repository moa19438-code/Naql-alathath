name: Build iOS (No Codesign)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build-ios:
    runs-on: macos-14

    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.19.6'
          architecture: x64

      - name: Build Admin Panel (iOS no-codesign)
        run: |
          set -euo pipefail
          cd admin_panel
          flutter create .

          # Force iOS 14 in Podfile
          if [ -f ios/Podfile ]; then
            if grep -qE '^\s*platform :ios' ios/Podfile; then
              sed -i '' -E "s/^\s*platform :ios.*/platform :ios, '14.0'/" ios/Podfile
            else
              printf "platform :ios, '14.0'\n\n" | cat - ios/Podfile > ios/Podfile.tmp && mv ios/Podfile.tmp ios/Podfile
            fi
          fi

          # Force iOS 14 in Xcode project
          if [ -f ios/Runner.xcodeproj/project.pbxproj ]; then
            sed -i '' -E "s/IPHONEOS_DEPLOYMENT_TARGET = [0-9.]*;/IPHONEOS_DEPLOYMENT_TARGET = 14.0;/g" ios/Runner.xcodeproj/project.pbxproj
          fi

          flutter pub get
          flutter build ios --release --no-codesign
          cd ..

      - name: Build Customer App (iOS no-codesign)
        run: |
          set -euo pipefail
          cd customer_app
          flutter create .

          # Read Google Maps API key from lib/config/keys.dart
          MAPS_KEY="$(grep -oE "googleMapsApiKey\s*=\s*'[^']+'" lib/config/keys.dart | head -n 1 | sed -E "s/.*'([^']+)'.*/\1/")"
          if [ -z "$MAPS_KEY" ]; then
            echo "ERROR: Could not read googleMapsApiKey from lib/config/keys.dart"
            exit 1
          fi
          echo "Google Maps key loaded."

          # Patch AppDelegate.swift or AppDelegate.m (Google Maps iOS needs provideAPIKey)
          if [ -f ios/Runner/AppDelegate.swift ]; then
            # add import GoogleMaps (after import Flutter) if missing
            if ! grep -q "import GoogleMaps" ios/Runner/AppDelegate.swift; then
              perl -i -pe 's/^import Flutter\s*$/import Flutter\nimport GoogleMaps/m' ios/Runner/AppDelegate.swift
            fi
            # add GMSServices.provideAPIKey(...) after GeneratedPluginRegistrant.register if missing
            if ! grep -q "GMSServices.provideAPIKey" ios/Runner/AppDelegate.swift; then
              perl -i -pe "s/(GeneratedPluginRegistrant\\.register\\(with:\\s*self\\)\\s*)/\\1GMSServices.provideAPIKey(\"$MAPS_KEY\")\\n/m" ios/Runner/AppDelegate.swift
            fi
          elif [ -f ios/Runner/AppDelegate.m ]; then
            if ! grep -q "<GoogleMaps/GoogleMaps.h>" ios/Runner/AppDelegate.m; then
              perl -i -pe 'print qq(#import <GoogleMaps/GoogleMaps.h>\n) if $.==1' ios/Runner/AppDelegate.m
            fi
            if ! grep -q "\\[GMSServices provideAPIKey" ios/Runner/AppDelegate.m; then
              perl -i -pe "s/(\\[GeneratedPluginRegistrant registerWithRegistry:self\\];)/[GMSServices provideAPIKey:@\"$MAPS_KEY\"];\\n\\1/" ios/Runner/AppDelegate.m
            fi
          else
            echo "WARNING: No AppDelegate file found to patch."
          fi

          # Add Location permission strings to Info.plist (prevents crash when requesting location)
          PLIST="ios/Runner/Info.plist"
          if [ -f "$PLIST" ]; then
            /usr/libexec/PlistBuddy -c "Add :NSLocationWhenInUseUsageDescription string نحتاج موقعك لعرض الخريطة وتحسين تجربة الطلب." "$PLIST" 2>/dev/null || \
            /usr/libexec/PlistBuddy -c "Set :NSLocationWhenInUseUsageDescription نحتاج موقعك لعرض الخريطة وتحسين تجربة الطلب." "$PLIST"

            /usr/libexec/PlistBuddy -c "Add :NSLocationAlwaysAndWhenInUseUsageDescription string نحتاج موقعك أثناء تنفيذ الطلب والتتبع." "$PLIST" 2>/dev/null || \
            /usr/libexec/PlistBuddy -c "Set :NSLocationAlwaysAndWhenInUseUsageDescription نحتاج موقعك أثناء تنفيذ الطلب والتتبع." "$PLIST"

            /usr/libexec/PlistBuddy -c "Add :NSLocationAlwaysUsageDescription string نحتاج موقعك أثناء تنفيذ الطلب والتتبع." "$PLIST" 2>/dev/null || \
            /usr/libexec/PlistBuddy -c "Set :NSLocationAlwaysUsageDescription نحتاج موقعك أثناء تنفيذ الطلب والتتبع." "$PLIST"
          fi

          # Force iOS 14 in Podfile (google_maps_flutter_ios requires it)
          if [ -f ios/Podfile ]; then
            if grep -qE '^\s*platform :ios' ios/Podfile; then
              sed -i '' -E "s/^\s*platform :ios.*/platform :ios, '14.0'/" ios/Podfile
            else
              printf "platform :ios, '14.0'\n\n" | cat - ios/Podfile > ios/Podfile.tmp && mv ios/Podfile.tmp ios/Podfile
            fi
          fi

          # Force iOS 14 in Xcode project
          if [ -f ios/Runner.xcodeproj/project.pbxproj ]; then
            sed -i '' -E "s/IPHONEOS_DEPLOYMENT_TARGET = [0-9.]*;/IPHONEOS_DEPLOYMENT_TARGET = 14.0;/g" ios/Runner.xcodeproj/project.pbxproj
          fi

          flutter pub get
          flutter build ios --release --no-codesign
          cd ..

      - name: Build Driver App (iOS no-codesign)
        run: |
          set -euo pipefail
          cd driver_app
          flutter create .

          # Force iOS 14 in Podfile
          if [ -f ios/Podfile ]; then
            if grep -qE '^\s*platform :ios' ios/Podfile; then
              sed -i '' -E "s/^\s*platform :ios.*/platform :ios, '14.0'/" ios/Podfile
            else
              printf "platform :ios, '14.0'\n\n" | cat - ios/Podfile > ios/Podfile.tmp && mv ios/Podfile.tmp ios/Podfile
            fi
          fi

          # Force iOS 14 in Xcode project
          if [ -f ios/Runner.xcodeproj/project.pbxproj ]; then
            sed -i '' -E "s/IPHONEOS_DEPLOYMENT_TARGET = [0-9.]*;/IPHONEOS_DEPLOYMENT_TARGET = 14.0;/g" ios/Runner.xcodeproj/project.pbxproj
          fi

          flutter pub get
          flutter build ios --release --no-codesign
          cd ..

      - name: Upload iOS build outputs (Runner.app)
        uses: actions/upload-artifact@v4
        with:
          name: iOS-build-outputs
          path: |
            admin_panel/build/ios/iphoneos/Runner.app
            customer_app/build/ios/iphoneos/Runner.app
            driver_app/build/ios/iphoneos/Runner.app
