name: Build iOS IPAs

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build-ios:
    runs-on: macos-14

    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.19.6'
          architecture: x64

      - name: Build Admin Panel
        run: |
          set -euo pipefail
          cd admin_panel
          flutter create .

          # Fix CocoaPods platform (required)
          if [ -f ios/Podfile ]; then
            if grep -q "^platform :ios" ios/Podfile; then
              sed -i '' "s/^platform :ios, .*/platform :ios, '14.0'/" ios/Podfile
            else
              sed -i '' "1s/^/platform :ios, '14.0'\n\n/" ios/Podfile
            fi
          fi

          # Force iOS deployment target in Xcode project too
          if [ -f ios/Runner.xcodeproj/project.pbxproj ]; then
            sed -i '' "s/IPHONEOS_DEPLOYMENT_TARGET = [0-9.]*;/IPHONEOS_DEPLOYMENT_TARGET = 14.0;/g" ios/Runner.xcodeproj/project.pbxproj
          fi

          flutter pub get
          flutter build ios --release --no-codesign

          rm -rf Payload
          mkdir Payload
          cp -r build/ios/iphoneos/Runner.app Payload/
          rm -f AdminPanel.ipa
          zip -r AdminPanel.ipa Payload
          rm -rf Payload
          cd ..

      - name: Build Customer App
        run: |
          set -euo pipefail
          cd customer_app
          flutter create .

          # -----------------------------
          # Read Google Maps API key from Dart file
          # -----------------------------
          MAPS_KEY="$(sed -n "s/.*googleMapsApiKey *= *'\(.*\)'.*/\1/p" lib/config/keys.dart | head -n 1)"
          if [ -z "${MAPS_KEY}" ]; then
            echo "ERROR: Could not read googleMapsApiKey from lib/config/keys.dart"
            exit 1
          fi
          echo "Google Maps key loaded."

          # -----------------------------
          # Add Google Maps key to AppDelegate (prevents crash)
          # Supports Swift and ObjC templates
          # -----------------------------
          APPDELEGATE_SWIFT="ios/Runner/AppDelegate.swift"
          APPDELEGATE_OBJC="ios/Runner/AppDelegate.m"

          if [ -f "$APPDELEGATE_SWIFT" ]; then
            # Ensure import GoogleMaps
            if ! grep -q "import GoogleMaps" "$APPDELEGATE_SWIFT"; then
              # Add after Flutter import line
              sed -i '' "/import Flutter/a\\
import GoogleMaps
" "$APPDELEGATE_SWIFT"
            fi

            # Ensure provideAPIKey is called before plugin registration
            if ! grep -q "GMSServices.provideAPIKey" "$APPDELEGATE_SWIFT"; then
              sed -i '' "/GeneratedPluginRegistrant.register/a\\
    GMSServices.provideAPIKey(\"${MAPS_KEY}\")
" "$APPDELEGATE_SWIFT"
            fi
          elif [ -f "$APPDELEGATE_OBJC" ]; then
            # ObjC template
            if ! grep -q "#import <GoogleMaps/GoogleMaps.h>" "$APPDELEGATE_OBJC"; then
              sed -i '' "1s|^|#import <GoogleMaps/GoogleMaps.h>\\
|" "$APPDELEGATE_OBJC"
            fi
            if ! grep -q "\[GMSServices provideAPIKey" "$APPDELEGATE_OBJC"; then
              sed -i '' "/\[GeneratedPluginRegistrant registerWithRegistry:self\];/i\\
  [GMSServices provideAPIKey:@\"${MAPS_KEY}\"];
" "$APPDELEGATE_OBJC"
            fi
          else
            echo "WARNING: No AppDelegate found to patch."
          fi

          # -----------------------------
          # Add Location permission strings to Info.plist (prevents crash)
          # -----------------------------
          PLIST="ios/Runner/Info.plist"
          if [ -f "$PLIST" ]; then
            /usr/libexec/PlistBuddy -c "Add :NSLocationWhenInUseUsageDescription string نحتاج موقعك لعرض الخريطة وتحسين تجربة الطلب." "$PLIST" 2>/dev/null || \
            /usr/libexec/PlistBuddy -c "Set :NSLocationWhenInUseUsageDescription نحتاج موقعك لعرض الخريطة وتحسين تجربة الطلب." "$PLIST"

            /usr/libexec/PlistBuddy -c "Add :NSLocationAlwaysAndWhenInUseUsageDescription string نحتاج موقعك أثناء تنفيذ الطلب والتتبع." "$PLIST" 2>/dev/null || \
            /usr/libexec/PlistBuddy -c "Set :NSLocationAlwaysAndWhenInUseUsageDescription نحتاج موقعك أثناء تنفيذ الطلب والتتبع." "$PLIST"

            /usr/libexec/PlistBuddy -c "Add :NSLocationAlwaysUsageDescription string نحتاج موقعك أثناء تنفيذ الطلب والتتبع." "$PLIST" 2>/dev/null || \
            /usr/libexec/PlistBuddy -c "Set :NSLocationAlwaysUsageDescription نحتاج موقعك أثناء تنفيذ الطلب والتتبع." "$PLIST"
          fi

          # -----------------------------
          # Force iOS 14 (google_maps_flutter_ios requires it)
          # -----------------------------
          if [ -f ios/Podfile ]; then
            if grep -q "^platform :ios" ios/Podfile; then
              sed -i '' "s/^platform :ios, .*/platform :ios, '14.0'/" ios/Podfile
            else
              sed -i '' "1s/^/platform :ios, '14.0'\n\n/" ios/Podfile
            fi
          fi

          if [ -f ios/Runner.xcodeproj/project.pbxproj ]; then
            sed -i '' "s/IPHONEOS_DEPLOYMENT_TARGET = [0-9.]*;/IPHONEOS_DEPLOYMENT_TARGET = 14.0;/g" ios/Runner.xcodeproj/project.pbxproj
          fi

          flutter pub get
          flutter build ios --release --no-codesign

          rm -rf Payload
          mkdir Payload
          cp -r build/ios/iphoneos/Runner.app Payload/
          rm -f CustomerApp.ipa
          zip -r CustomerApp.ipa Payload
          rm -rf Payload
          cd ..

      - name: Build Driver App
        run: |
          set -euo pipefail
          cd driver_app
          flutter create .

          # Fix CocoaPods platform (required)
          if [ -f ios/Podfile ]; then
            if grep -q "^platform :ios" ios/Podfile; then
              sed -i '' "s/^platform :ios, .*/platform :ios, '14.0'/" ios/Podfile
            else
              sed -i '' "1s/^/platform :ios, '14.0'\n\n/" ios/Podfile
            fi
          fi

          # Force iOS deployment target in Xcode project too
          if [ -f ios/Runner.xcodeproj/project.pbxproj ]; then
            sed -i '' "s/IPHONEOS_DEPLOYMENT_TARGET = [0-9.]*;/IPHONEOS_DEPLOYMENT_TARGET = 14.0;/g" ios/Runner.xcodeproj/project.pbxproj
          fi

          flutter pub get
          flutter build ios --release --no-codesign

          rm -rf Payload
          mkdir Payload
          cp -r build/ios/iphoneos/Runner.app Payload/
          rm -f DriverApp.ipa
          zip -r DriverApp.ipa Payload
          rm -rf Payload
          cd ..

      - name: Upload IPAs
        uses: actions/upload-artifact@v4
        with:
          name: iOS-IPAs
          path: |
            admin_panel/AdminPanel.ipa
            customer_app/CustomerApp.ipa
            driver_app/DriverApp.ipa
