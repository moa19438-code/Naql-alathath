name: Build iOS (No Codesign)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build-ios:
    runs-on: macos-14

    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.19.6'
          architecture: x64

      - name: Build Admin Panel (iOS no-codesign)
        run: |
          set -euo pipefail
          cd admin_panel
          flutter create .

          # Force iOS 14 in Podfile
          if [ -f ios/Podfile ]; then
            python3 -c "import pathlib,re; p=pathlib.Path('ios/Podfile'); t=p.read_text('utf-8'); \
t = re.sub(r'^\s*platform :ios,.*$', \"platform :ios, '14.0'\", t, flags=re.M) if re.search(r'^\s*platform :ios,', t, flags=re.M) else \"platform :ios, '14.0'\\n\\n\"+t; \
p.write_text(t,'utf-8')"
          fi

          # Force iOS 14 in Xcode project
          if [ -f ios/Runner.xcodeproj/project.pbxproj ]; then
            python3 -c "import pathlib,re; p=pathlib.Path('ios/Runner.xcodeproj/project.pbxproj'); t=p.read_text('utf-8'); \
t=re.sub(r'IPHONEOS_DEPLOYMENT_TARGET = [0-9.]*;', 'IPHONEOS_DEPLOYMENT_TARGET = 14.0;', t); p.write_text(t,'utf-8')"
          fi

          flutter pub get
          flutter build ios --release --no-codesign
          cd ..

      - name: Build Customer App (iOS no-codesign)
        run: |
          set -euo pipefail
          cd customer_app
          flutter create .

          # Add Location permission strings to Info.plist (prevents crash when requesting location)
          PLIST="ios/Runner/Info.plist"
          if [ -f "$PLIST" ]; then
            /usr/libexec/PlistBuddy -c "Add :NSLocationWhenInUseUsageDescription string نحتاج موقعك لعرض الخريطة وتحسين تجربة الطلب." "$PLIST" 2>/dev/null || \
            /usr/libexec/PlistBuddy -c "Set :NSLocationWhenInUseUsageDescription نحتاج موقعك لعرض الخريطة وتحسين تجربة الطلب." "$PLIST"

            /usr/libexec/PlistBuddy -c "Add :NSLocationAlwaysAndWhenInUseUsageDescription string نحتاج موقعك أثناء تنفيذ الطلب والتتبع." "$PLIST" 2>/dev/null || \
            /usr/libexec/PlistBuddy -c "Set :NSLocationAlwaysAndWhenInUseUsageDescription نحتاج موقعك أثناء تنفيذ الطلب والتتبع." "$PLIST"

            /usr/libexec/PlistBuddy -c "Add :NSLocationAlwaysUsageDescription string نحتاج موقعك أثناء تنفيذ الطلب والتتبع." "$PLIST" 2>/dev/null || \
            /usr/libexec/PlistBuddy -c "Set :NSLocationAlwaysUsageDescription نحتاج موقعك أثناء تنفيذ الطلب والتتبع." "$PLIST"
          fi

          # Force iOS 14 in Podfile
          if [ -f ios/Podfile ]; then
            python3 -c "import pathlib,re; p=pathlib.Path('ios/Podfile'); t=p.read_text('utf-8'); \
t = re.sub(r'^\s*platform :ios,.*$', \"platform :ios, '14.0'\", t, flags=re.M) if re.search(r'^\s*platform :ios,', t, flags=re.M) else \"platform :ios, '14.0'\\n\\n\"+t; \
p.write_text(t,'utf-8')"
          fi

          # Force iOS 14 in Xcode project
          if [ -f ios/Runner.xcodeproj/project.pbxproj ]; then
            python3 -c "import pathlib,re; p=pathlib.Path('ios/Runner.xcodeproj/project.pbxproj'); t=p.read_text('utf-8'); \
t=re.sub(r'IPHONEOS_DEPLOYMENT_TARGET = [0-9.]*;', 'IPHONEOS_DEPLOYMENT_TARGET = 14.0;', t); p.write_text(t,'utf-8')"
          fi

          flutter pub get
          flutter build ios --release --no-codesign
          cd ..

      - name: Build Driver App (iOS no-codesign)
        run: |
          set -euo pipefail
          cd driver_app
          flutter create .

          # Force iOS 14 in Podfile
          if [ -f ios/Podfile ]; then
            python3 -c "import pathlib,re; p=pathlib.Path('ios/Podfile'); t=p.read_text('utf-8'); \
t = re.sub(r'^\s*platform :ios,.*$', \"platform :ios, '14.0'\", t, flags=re.M) if re.search(r'^\s*platform :ios,', t, flags=re.M) else \"platform :ios, '14.0'\\n\\n\"+t; \
p.write_text(t,'utf-8')"
          fi

          # Force iOS 14 in Xcode project
          if [ -f ios/Runner.xcodeproj/project.pbxproj ]; then
            python3 -c "import pathlib,re; p=pathlib.Path('ios/Runner.xcodeproj/project.pbxproj'); t=p.read_text('utf-8'); \
t=re.sub(r'IPHONEOS_DEPLOYMENT_TARGET = [0-9.]*;', 'IPHONEOS_DEPLOYMENT_TARGET = 14.0;', t); p.write_text(t,'utf-8')"
          fi

          flutter pub get
          flutter build ios --release --no-codesign
          cd ..

      - name: Upload iOS build outputs
        uses: actions/upload-artifact@v4
        with:
          name: iOS-build-outputs
          path: |
            customer_app/build/ios/iphoneos/Runner.app
            driver_app/build/ios/iphoneos/Runner.app
            admin_panel/build/ios/iphoneos/Runner.app
